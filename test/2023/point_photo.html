<!DOCTYPE HTML>
<html lang="ja">
<title>pointmap</title>

<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="UTF-8" name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <script src="https://unpkg.com/deck.gl@^8.1.0/dist.min.js"></script>
  <script src='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js'></script>
  <link href='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css' rel='stylesheet' />

  <script src="https://d3js.org/d3.v5.min.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="../pointmap.css" />

</head>

<body>

  <div class="title p-3">2023.PointMap</div>

  <div id="container"></div>

  <div class="basic p-1">基本地図</div>
  <div class="photo p-1">航空写真</div>

  <script type="module">

    const { DeckGL, ScatterplotLayer, GeoJsonLayer } = deck;

    let lat; let lng; let zoom; let pitch; let bearing; let value;

    const url_hash = location.hash;
    let hash_last;

    if (url_hash === "") {
      lat = 37.066;
      lng = 137.175;
      zoom = 4.8;
      pitch = 40;
      bearing = -10;

    } else {
      console.log(url_hash);

      hash_last = url_hash.split("!");

      lat = Number(hash_last[1].split("/")[0]);
      lng = Number(hash_last[1].split("/")[1]);
      zoom = Number(hash_last[1].split("/")[2]);
      pitch = Number(hash_last[1].split("/")[3]);
      bearing = Number(hash_last[1].split("/")[4]);

    }

    const basemap = "../mapdata/basemap_tiri_photo.json";

    const data = await d3.csv('./all.csv');

    const INITIAL_VIEW_STATE = {
      longitude: lng,
      latitude: lat,
      zoom: zoom,
      minZoom: 3,
      pitch: pitch,
      maxPitch: 85,
      bearing: bearing
    };


    const tooltip = (d) => {

      if (!d || !d.object) return null;
      let obj = d.object;

      let title;

      title = obj.day + " " + obj.hh + "時" + obj.mm + "分";

      const html_tr = ["<table>", title, "</table>"].join("\n");

      return {
        html: html_tr
      };
    };

    const layer = new ScatterplotLayer({
      id: 'scatterplot-layer',
      data,
      pickable: true,
      opacity: 0.8,
      stroked: true,
      filled: true,
      radiusScale: 6,
      radiusMinPixels: 3,
      radiusMaxPixels: 10,
      lineWidthMinPixels: 1,
      getPosition: d => [Number(d.lng), Number(d.lat)],
      getFillColor: d => [232, 57, 41]
    })

    const prefectures_line = new GeoJsonLayer({
      id: 'prefectures_line',
      data: "../mapdata/prefectures_line.geojson",
      filled: true,
      lineWidthMinPixels: 2,
      getFillColor: [255, 255, 255],
      getLineColor: [255, 255, 255],
      getLineWidth: 2,
      opacity: 1,
      pickable: false
    });

    new DeckGL({
      container: 'container',
      mapStyle: basemap,
      initialViewState: INITIAL_VIEW_STATE,
      onViewStateChange: ({ viewState }) => {
        zoom = Math.round(viewState.zoom * 10) / 10;
        lat = Math.round(viewState.latitude * 1000) / 1000;
        lng = Math.round(viewState.longitude * 1000) / 1000;
        pitch = Math.round(viewState.pitch * 10) / 10;
        bearing = Math.round(viewState.bearing * 100) / 100;
      },
      controller: {
        touchRotate: true
      },
      layers: [prefectures_line, layer],
      getTooltip: tooltip
    });

    const basic = document.querySelector('.basic');
    const photo = document.querySelector('.photo');

    basic.addEventListener('click', () => {
      location.href = "./point.html#!" + lat + "/" + lng + "/" + zoom + "/" + pitch + "/" + bearing;

    });

    photo.addEventListener('click', () => {
      location.href = "./point_photo.html#!" + lat + "/" + lng + "/" + zoom + "/" + pitch + "/" + bearing;
    });


  </script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MPP84V2NHB"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-MPP84V2NHB');
  </script>

</body>

</html>