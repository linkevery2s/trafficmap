<!DOCTYPE HTML>
<html lang="ja">
<title>pointmap</title>

<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="UTF-8" name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <script src="https://unpkg.com/deck.gl@^8.9.0/dist.min.js"></script>
  <script src='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js'></script>
  <link href='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css' rel='stylesheet' />

  <script src="https://d3js.org/d3.v5.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"
    integrity="sha512-GWzVrcGlo0TxTRvz9ttioyYJ+Wwk9Ck0G81D+eO63BaqHaJ3YZX9wuqjwgfcV/MrB2PhaVX9DkYVhbFpStnqpQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

  <link href='./rotate.css' rel='stylesheet' />
  <link href="./pointmap.css" rel="stylesheet" />

</head>

<body>

  <div class="title p-3"><span id="title"></span></div>

  <div id="container"></div>

  <span class="side_menu">
    <div class="button" id="button"><i class="fa-solid fa-rotate"></i></div>
    <div class="button2" id="button2"><i class="fa-solid fa-lg fa-stop"></i></div>
  </span>

  <div class="basic p-1">基本地図</div>
  <div class="photo p-1">航空写真</div>

  <script type="module">

    const { DeckGL, ScatterplotLayer, LinearInterpolator } = deck;

    let lat; let lng; let zoom; let pitch; let bearing; let value; let year; let data;

    const url_hash = location.hash;
    let hash_last;

    if (url_hash === "") {
      lat = 37.066;
      lng = 137.175;
      zoom = 4.8;
      pitch = 40;
      bearing = -10;
      year = 2023;

    } else {
      console.log(url_hash);

      hash_last = url_hash.split("!");

      lat = Number(hash_last[1].split("/")[0]);
      lng = Number(hash_last[1].split("/")[1]);
      zoom = Number(hash_last[1].split("/")[2]);
      pitch = Number(hash_last[1].split("/")[3]);
      bearing = Number(hash_last[1].split("/")[4]);
      year = Number(hash_last[1].split("/")[5]);

      title.innerHTML = year + ".PointMap(basic)";

    }

    const basemap = "https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json";

    data = await d3.csv(year + '/all.csv');

    let initialViewState = {
      longitude: lng,
      latitude: lat,
      zoom: zoom,
      minZoom: 3,
      pitch: pitch,
      maxPitch: 85,
      bearing: bearing
    };

    const tooltip = (d) => {

      if (!d || !d.object) return null;
      let obj = d.object;

      let title;

      title = obj.date + " " + obj.hh + "時" + obj.mm + "分";

      const html_tr = ["<table>", title, "</table>"].join("\n");

      return {
        html: html_tr
      };
    };

    const layer = new ScatterplotLayer({
      id: 'scatterplot-layer',
      data,
      pickable: true,
      opacity: 0.8,
      stroked: true,
      filled: true,
      radiusScale: 6,
      radiusMinPixels: 3,
      radiusMaxPixels: 10,
      lineWidthMinPixels: 1,
      getPosition: d => [Number(d.lng), Number(d.lat)],
      getFillColor: d => [232, 57, 41]
    });

    let rotateCamera = () => {
      initialViewState = {
        ...initialViewState,
        bearing: initialViewState.bearing - 10,
        transitionDuration: 500,
        transitionInterpolator: new LinearInterpolator(['bearing']),
        onTransitionEnd: rotateCamera
      };
      deckgl.setProps({ initialViewState });
    };

    let stop = () => {
      initialViewState = {
        ...initialViewState,
        bearing: initialViewState.bearing - 0.01,
        transitionDuration: 0,
        transitionInterpolator: new LinearInterpolator(['bearing']),
        onTransitionEnd: stop
      };
      deckgl.setProps({ initialViewState });

    };

    const deckgl = new DeckGL({
      container: 'container',
      mapStyle: basemap,
      initialViewState: initialViewState,
      onViewStateChange: ({ viewState }) => {
        initialViewState.longitude = viewState.longitude;
        initialViewState.latitude = viewState.latitude;
        initialViewState.zoom = viewState.zoom;
        initialViewState.pitch = viewState.pitch;
        initialViewState.bearing = viewState.bearing;

        zoom = Math.round(viewState.zoom * 10) / 10;
        lat = Math.round(viewState.latitude * 1000) / 1000;
        lng = Math.round(viewState.longitude * 1000) / 1000;
        pitch = Math.round(viewState.pitch * 10) / 10;
        bearing = Math.round(viewState.bearing * 100) / 100;
      },
      controller: {
        touchRotate: true
      },
      layers: layer,
      getTooltip: tooltip
    });

    const basic = document.querySelector('.basic');
    const photo = document.querySelector('.photo');

    basic.addEventListener('click', () => {
      location.href = "./point.html#!" + lat + "/" + lng + "/" + zoom + "/" + pitch + "/" + bearing + "/" + year;

    });

    photo.addEventListener('click', () => {
      location.href = "./point_photo.html#!" + lat + "/" + lng + "/" + zoom + "/" + pitch + "/" + bearing + "/" + year;
    });

    const button = document.querySelector('.button');
    const button2 = document.querySelector('.button2');
    button.addEventListener('click', () => {
      rotateCamera();
      $("#button").hide();
      $("#button2").show();
    });

    button2.addEventListener('click', () => {
      stop();
      $("#button2").hide();
      $("#button").show();
    });

  </script>

</body>

</html>